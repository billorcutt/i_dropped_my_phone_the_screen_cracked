!function(){"use strict";function find(){if(arguments&&arguments.length)if(recordingMacro())findInMacro(arguments[0]);else if(__.isStr(arguments[0])){var selector=arguments[0];_currentSelector=selector,_selectedNodes=getNodesWithSelector(selector)}else __.isObj(arguments[0])&&"AudioNode"===arguments[0].constructor.name&&(_currentSelector=arguments[0].getType(),_selectedNodes=[arguments[0].getUUID()]);else reset();return _previousNode=null,cracked}function findInMacro(){if(arguments&&arguments.length)if(__.isStr(arguments[0])){var macroUUID=getCurrentMacro().getUUID();_currentSelector=processSelectorForMacro(arguments[0]),_selectedNodes=getNodesWithSelector(_currentSelector),_selectedNodes.forEach(function(el,i,arr){el&&getNodeWithUUID(el).getMacroContainerUUID()!==macroUUID&&arr.splice(i,1)})}else __.isObj(arguments[0])&&"AudioNode"===arguments[0].constructor.name&&(_currentSelector=getCurrentMacroNamespace()+" "+arguments[0].getType(),_selectedNodes=[arguments[0].getUUID()])}function processSelectorForMacro(selector){for(var selectorArr=selector.split(","),prefix=getCurrentMacroNamespace(),i=0;i<selectorArr.length;i++)selectorArr[i]=-1!==selectorArr[i].indexOf(prefix)?selectorArr[i]:prefix+selectorArr[i];return selectorArr.join(",")}function reset(){_previousNode=null,_selectedNodes=[],_currentSelector=""}function resetSelection(){_selectedNodes=[],_currentSelector=""}function createNode(type,creationParams,userSettings){var node=new AudioNode(type,creationParams,userSettings||{});if(saveNode(node),node.isMacro())return node;for(var nodesToConnect=_selectedNodes.length?_selectedNodes:[getPreviousNode()],i=0;i<nodesToConnect.length;i++){var nodeToConnect=getNodeWithUUID(nodesToConnect[i]);if(nodeToConnect)try{nodeToConnect.connect(node),nodeToConnect.pushNextNode(node),node.setPrevNode(nodeToConnect),logConnections(nodeToConnect,node)}catch(e){throw console.error("ERROR : couldn't connect nodes "+nodeToConnect.getType()+" and "+node.getType()),e}}return resetSelection(),setPreviousNode(node),node}function audioNodeFactory(creationParams){var node;if(_context&&creationParams.method&&_context[creationParams.method]){node=_context[creationParams.method].apply(_context,creationParams.methodParams||[]);for(var creationParam in creationParams.settings)creationParams.settings.hasOwnProperty(creationParam)&&("to_channel"===creationParam||"from_channel"===creationParam?node[creationParam]=creationParams.settings[creationParam]:applyParam(node,creationParam,creationParams.settings[creationParam],creationParams.mapping))}else if(_context&&"createDestination"===creationParams.method)node=_context.destination;else if(_context&&"createOrigin"===creationParams.method)node=createMockMediaStream(creationParams);else{if(!_context||"createMacro"!==creationParams.method)throw new Error("Couldn't create audio node. Create method "+creationParams.method+" not supported.");node=[]}return logToConsole(node),node}function AudioNode(type,creationParams,userSettings){function getParamValue(node,keyStr,map){for(var mappingResult=resolveParamMapping(keyStr,map),keyArr=mappingResult.path.split("."),i=0;i<keyArr.length;i++){if(!(i+1<keyArr.length&&node[keyArr[i]]))return node[keyArr[i]]?node[keyArr[i]]:null;node=node[keyArr[i]]}}function updateNativeNode(newNode,id){newNode.uuid=id,updateNativeNodeHelper(nativeNode,newNode)}function updateNativeNodeHelper(currNode,newNode){currNode.forEach(function(n,i,a){__.isArr(n)?updateNativeNodeHelper(n,newNode):n.uuid===newNode.uuid&&(a[i]=newNode)})}function getNodesToConnect(fromNode,toNode){return fromNode&&fromNode.isModulator()&&toNode&&!fromNode.areSiblings(toNode)?{from:getNodeToConnect(fromNode,"from"),to:getNodeToConnectToModulator(toNode,fromNode.isModulatorType())}:{from:getNodeToConnect(fromNode,"from"),to:getNodeToConnect(toNode,"to")}}function getNodeToConnect(node,whichNode){if(node){var rawNode=node.getNativeNode();return __.isArr(rawNode)&&(rawNode="from"===whichNode?getRawNode(rawNode,rawNode.length-1):getRawNode(rawNode,0)),rawNode}return null}function getRawNode(node,position){if(__.isArr(node)){var pos=position?node.length-1:0;return getRawNode(node[position],pos)}return node}function getNodeToConnectToModulator(node,property){if(node){var rawNode=node.getNativeNode(),resolvedProperty=property;if(__.isArr(rawNode)){for(var i=0;i<rawNode.length;i++)if(resolvedProperty=resolveParamMapping(property,getNodeWithUUID(rawNode[i].uuid).getParamMapping()).path.replace(".value",""),__.isNotUndef(rawNode[i][resolvedProperty])){rawNode=rawNode[i][resolvedProperty];break}}else resolvedProperty=resolveParamMapping(property,node.getParamMapping()).path.replace(".value",""),rawNode=rawNode[resolvedProperty]?rawNode[resolvedProperty]:null;return rawNode}return null}var uuid,macroContainerUUID,parameters,nodeType,nativeNode,prevNode,macroNameSpace="",isPlaying=!1,nextNode=[],paramMapping={},that=this;uuid=generateUUID(),mergeObjects(userSettings,creationParams.settings),mergeObjects(userSettings.mapping,creationParams.mapping),parameters=creationParams,paramMapping=creationParams.mapping||creationParams.settings.mapping,nodeType=type,nativeNode=audioNodeFactory(parameters),nativeNode.uuid=uuid,this.start=function(nodeParam){var currNode=nodeParam||nativeNode;if(__.isArr(currNode))currNode.forEach(function(_node,_i,_array){that.start(_node)});else if(currNode&&__.isFun(currNode.start)){var wrapper=getNodeWithUUID(currNode.uuid);if(!wrapper.getIsPlaying()){var offset=currNode&&currNode.loopStart&&__.isNum(currNode.loopStart)?currNode.loopStart:0,time=(currNode&&currNode.loopEnd&&__.isNum(currNode.loopEnd)&&currNode.loopEnd,_ignoreGrid?_context.currentTime:_loopTimeToNextStep);offset?currNode.start(time,offset):currNode.start(time),wrapper.setIsPlaying(!0),this.setIsPlaying(!0)}}},this.stop=function(nodeParam){var currNode=nodeParam||nativeNode;if(__.isArr(currNode))currNode.forEach(function(_node,_i,_array){that.stop(_node)});else if(currNode&&__.isFun(currNode.stop)){var wrapper=getNodeWithUUID(currNode.uuid);if(wrapper.getIsPlaying()){var time=_ignoreGrid?_context.currentTime:_loopTimeToNextStep;currNode.stop(time),this.resetNode(currNode),wrapper.setIsPlaying(!1),this.setIsPlaying(!1)}}},this.ramp=function(target,time,paramToRamp,nodeParam,initial,type){var _target,currNode=nodeParam||nativeNode,rampMethod="exp"===type?"exponentialRampToValueAtTime":"linearRampToValueAtTime";if(__.isArr(currNode))currNode.forEach(function(_node,_i,_array){that.ramp(target,time,paramToRamp,_node,initial)});else{var now=_ignoreGrid?_context.currentTime:_loopTimeToNextStep;if(currNode&&currNode[paramToRamp]&&__.isFun(currNode[paramToRamp][rampMethod])){currNode[paramToRamp].cancelScheduledValues(now);var initialValue=__.ifUndef(initial,currNode[paramToRamp].value),prevTime=0;if(currNode[paramToRamp].setValueAtTime(initialValue,now),__.isArr(target)&&__.isArr(time)&&target.length===time.length)for(var i=0;i<target.length;i++)prevTime=__.isUndef(time[i-1])?0:time[i-1]+prevTime,logToConsole(" target "+target[i]+" time "+(_context.currentTime+prevTime+time[i])+" current time "+_context.currentTime),_target=0===target[i]&&"exp"===type?1e-4:target[i],currNode[paramToRamp][rampMethod](_target,now+prevTime+time[i]);else _ignoreGrid||__.sec2ms(time)!==_loopInterval||(time=Math.min(time,_loopTimeToNextStep-_context.currentTime)),logToConsole(" target "+target+" time "+(_context.currentTime+prevTime+time)+" current time "+_context.currentTime),_target=0===target&&"exp"===type?1e-4:target,currNode[paramToRamp][rampMethod](_target,now+time)}}},this.getAttr=function(userParams){var nativeNode=this.getNativeNode(),values=[];if(__.isArr(nativeNode))flatten(nativeNode).forEach(function(_node,_i,_array){var mapping=getNodeWithUUID(_node.uuid).getParamMapping();values.push(getParamValue(_node,userParams,mapping||{})),logToConsole(_node)});else{var mapping=getNodeWithUUID(nativeNode.uuid).getParamMapping();values.push(getParamValue(nativeNode,userParams,mapping||{})),logToConsole(nativeNode)}return values[0]},this.attr=function(userParams){for(var key in userParams)if(userParams.hasOwnProperty(key)&&__.isNotUndef(userParams[key])){var nativeNode=this.getNativeNode();if(__.isArr(nativeNode))flatten(nativeNode).forEach(function(_node,_i,_array){var mapping=userParams.mapping||getNodeWithUUID(_node.uuid).getParamMapping();applyParam(_node,key,userParams[key],mapping||{}),logToConsole(_node)});else{var mapping=userParams.mapping||getNodeWithUUID(nativeNode.uuid).getParamMapping();applyParam(nativeNode,key,userParams[key],mapping||{}),logToConsole(nativeNode)}}},this.search=function(str){var nodes=[];if(str)for(var prefix=this.getMacroNameSpace(),selector=prefix+str,nodeIds=getNodesWithSelector(selector),i=0;i<nodeIds.length;i++)getNodeWithUUID(nodeIds[i]).getMacroContainerUUID()===this.getUUID()&&nodes.push(nodeIds[i]);return nodes},this.getMacroNameSpace=function(){return macroNameSpace},this.setMacroNameSpace=function(name){name&&(macroNameSpace=name)},this.isMacro=function(){return __.isArr(nativeNode)},this.isMacroComponent=function(){return __.isNotUndef(macroContainerUUID)},this.setMacroContainerUUID=function(uuid){__.isStr(uuid)&&(macroContainerUUID=uuid)},this.getMacroContainerUUID=function(){return macroContainerUUID},this.getIsPlaying=function(){return isPlaying},this.setIsPlaying=function(bool){isPlaying=bool},this.getPrevNode=function(){return prevNode},this.setPrevNode=function(node){prevNode=node},this.pushNextNode=function(node){if(node){var nodes=getNodesToConnect(this,node),fromNode=getNodeWithUUID(nodes.from.uuid);fromNode.getUUID()!==this.getUUID()?fromNode.pushNextNode(node):nextNode.push(node)}},this.getUUID=function(){return uuid},this.getParams=function(){return parameters},this.getParamMapping=function(){return paramMapping},this.getType=function(){return nodeType},this.getID=function(){return parameters.settings.id||""},this.getClass=function(){return parameters.settings.class||""},this.areSiblings=function(node){var parentNodeID=__.isObj(node)?node.getMacroContainerUUID():__.isStr(node)?getNodeWithUUID(node).getMacroContainerUUID():"";return parentNodeID&&this.getMacroContainerUUID()&&parentNodeID===this.getMacroContainerUUID()},this.isModulator=function(){return!(!this.getMacroContainerUUID()||!getNodeWithUUID(this.getMacroContainerUUID()).getParams().settings.modulates)||!!this.getParams().settings.modulates},this.isModulatorType=function(){return this.isModulator()&&this.getMacroContainerUUID()&&getNodeWithUUID(this.getMacroContainerUUID()).getParams().settings.modulates?getNodeWithUUID(this.getMacroContainerUUID()).getParams().settings.modulates:this.isModulator()?this.getParams().settings.modulates:""},this.addNativeNode=function(nodeToAdd){nativeNode.push(nodeToAdd)},this.getNativeNode=function(){return nativeNode},this.replaceNode=function(node){var saved_buffer=nativeNode.buffer;nativeNode=node,nativeNode.uuid=this.getUUID();for(var i=0;i<nextNode.length;i++)this.connect(nextNode[i]);this.connectPrevious(),this.setIsPlaying(!1),saved_buffer&&(nativeNode.buffer=saved_buffer)},this.resetNode=function(currNode){if(this.isMacro())getNodeWithUUID(currNode.uuid).resetNode(),updateNativeNode(getNodeWithUUID(currNode.uuid).getNativeNode(),currNode.uuid);else{var saved_buffer=nativeNode.buffer;nativeNode=audioNodeFactory(parameters),nativeNode.uuid=this.getUUID();for(var i=0;i<nextNode.length;i++)this.connect(nextNode[i]);this.connectPrevious(),this.setIsPlaying(!1),saved_buffer&&(nativeNode.buffer=saved_buffer)}},this.disconnect=function(nodeParam){var currNode=nodeParam||nativeNode;if(__.isArr(currNode))currNode.forEach(function(_node,_i,_array){that.disconnect(_node)});else if(currNode&&__.isFun(currNode.disconnect)){var wrapper=getNodeWithUUID(currNode.uuid);try{currNode.disconnect()}catch(e){}wrapper.setIsPlaying(!1),this.setIsPlaying(!1)}},this.connect=function(nodeToConnect){if(nodeToConnect&&this.getUUID()!==nodeToConnect.getUUID()){var nodes=getNodesToConnect(this,nodeToConnect);if(nodes.from&&__.isFun(nodes.from.connect)&&nodes.to){var from_channel=nodes.from.from_channel,to_channel=nodes.from.to_channel;__.isNotUndef(from_channel)&&__.isNotUndef(to_channel)?nodes.from.connect(nodes.to,from_channel,to_channel):nodes.from.connect(nodes.to)}else logToConsole("ERROR - connect did not happen")}},this.connectPrevious=function(){var pNode=this.getPrevNode();if(pNode&&this.getUUID()!==pNode.getUUID()){var nodes=getNodesToConnect(pNode,this);if(nodes.from&&__.isFun(nodes.from.connect)&&nodes.to){var from_channel=nodes.from.from_channel,to_channel=nodes.from.to_channel;__.isNotUndef(from_channel)&&__.isNotUndef(to_channel)?nodes.from.connect(nodes.to,from_channel,to_channel):nodes.from.connect(nodes.to)}else logToConsole("ERROR - connect did not happen")}}}function applyParam(node,keyStr,value,map){for(var mappingResult=resolveParamMapping(keyStr,map),keyArr=mappingResult.path.split("."),keyFunc=mappingResult.fn||function(val){return val},i=0;i<keyArr.length;i++)i+1<keyArr.length&&__.isNotUndef(node[keyArr[i]])?"AudioParam"===node[keyArr[i]].constructor.name?setAudioParam(node[keyArr[i]],value):node=node[keyArr[i]]:node&&__.isNotUndef(node[keyArr[i]])&&(node[keyArr[i]]=keyFunc(value))}function setAudioParam(node,value){if(node&&__.isFun(node.setValueAtTime)){var time=_ignoreGrid?_context.currentTime:_loopTimeToNextStep;node.cancelScheduledValues(time),node.setValueAtTime(value,time)}}function resolveParamMapping(name,map){var mapping=map||{},result=mapping[name]||name;return result.path?result:{path:result}}function createMockMediaStream(creationParams){creationParams.method="createBufferSource";var tmpnode=_context[creationParams.method].apply(_context,creationParams.methodParams||[]);for(var creationParam in creationParams.settings)creationParams.settings.hasOwnProperty(creationParam)&&applyParam(tmpnode,creationParam,creationParams.settings[creationParam],creationParams.mapping);return tmpnode}function createMediaStreamSourceNode(params,temporaryNode){var newNode=null;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?navigator.getUserMedia({audio:!0},function(params){var p=params;return function(stream){p.method="createMediaStreamSource",p.methodParams=[stream],newNode=audioNodeFactory(p),getNodeWithUUID(temporaryNode.getNativeNode().uuid).replaceNode(newNode)}}(params),function(error){console.error("createMediaStreamSourceNode: getUserMedia failed.")}):console.error("createMediaStreamSourceNode: getUserMedia not supported.")}function loadBuffer(userParams,node){userParams&&userParams.path&&node?loadBufferFromFile(userParams.path,node.getNativeNode()):userParams&&userParams.fn&&node&&loadBufferWithData(userParams.fn,node.getNativeNode())}function loadBufferWithData(dataFunction,buffersrc){dataFunction&&buffersrc&&(buffersrc.buffer=dataFunction(_context))}function loadBufferFromFile(path_to_soundfile,buffersrc){path_to_soundfile&&buffersrc&&fetchSoundFile(path_to_soundfile,function(sndArray){_context.decodeAudioData(sndArray,function(buf){buffersrc.buffer=buf,logToConsole("sound loaded")},function(e){logToConsole("Couldn't load audio")})})}function fetchSoundFile(path,callback){if(path&&callback){var request=new XMLHttpRequest;request.open("GET",path,!0),request.responseType="arraybuffer",request.onload=function(){__.isFun(callback)&&callback(request.response)},request.send()}}function toggleGrid(){_isLoopRunning&&(_ignoreGrid=!_ignoreGrid)}function calculateTimeout(){return __.sec2ms(_loopTimeToNextStep-_context.currentTime-__.ms2sec(_loopInterval*_loopTolerance))}function startLoop(){_isLoopRunning||(_loopInit(),_loopTimeToNextStep=_context.currentTime+_loopInterval/1e3,_isLoopRunning=!0,_ignoreGrid=!1,_timerWorker&&_timerWorker.postMessage("start"))}function stopLoop(){_isLoopRunning&&(_isLoopRunning=!1,_loopTimeToNextStep=0,_ignoreGrid=!0,_timerWorker&&_timerWorker.postMessage("stop"))}function resetLoop(){_loopStepSize=0,_loopInterval=100,_ignoreGrid=!0,_loopCB=null,_loopData=[],_loopListeners=[],_loopIndex=-1,_loopCount=0,_isLoopRunning=!1,_loopTimeToNextStep=0}function configureLoop(opts,fn,data){opts&&__.isObj(opts)?_loopInterval=opts.interval||200:opts&&__.isNum(opts)&&!fn&&!data&&(_loopInterval=opts),__.isFun(fn)&&(_loopCB=fn),__.isArr(data)?(_loopData=data,_loopStepSize=data.length):_loopData=[]}function checkup(){if(_isLoopRunning){var now=_context.currentTime,loopIntervalInSecs=__.ms2sec(_loopInterval),timeAtPreviousStep=_loopTimeToNextStep-loopIntervalInSecs;now<_loopTimeToNextStep&&now>timeAtPreviousStep?(loopStep(),_loopTimeToNextStep+=loopIntervalInSecs):now>_loopTimeToNextStep&&(_loopTimeToNextStep+=loopIntervalInSecs)}}function loopStep(){_loopStepSize&&(_loopIndex=_loopIndex<_loopStepSize-1?_loopIndex+1:0),__.isFun(_loopCB)&&_loopCB(_loopIndex,cracked.ifUndef(_loopData[_loopIndex],null),_loopData,++_loopCount);for(var i=0;i<_loopListeners.length;i++){var listener=_loopListeners[i],tmp=_selectedNodes,index=listener.loopIndex,stepSize=listener.loopStepSize,data=listener.data,count=++listener.count;listener.loopIndex=index<stepSize-1?index+1:0,_selectedNodes=listener.selection,listener.callback(listener.loopIndex,cracked.ifUndef(data[listener.loopIndex],null),data,count),_selectedNodes=tmp}}function _loopInit(){var jstext='var timerID=null,interval=100;self.onmessage=function(a){"start"==a.data?timerID=setInterval(function(){postMessage("tick")},interval):a.data.interval?(interval=a.data.interval,timerID&&(clearInterval(timerID),timerID=setInterval(function(){postMessage("tick")},interval))):"stop"==a.data&&(clearInterval(timerID),timerID=null)};',blob=new Blob([jstext]),blobURL=window.URL.createObjectURL(blob);_timerWorker=new Worker(blobURL),_timerWorker.onmessage=function(e){"tick"===e.data?checkup():console.error("message: "+e.data)},_timerWorker.postMessage({interval:calculateTimeout()})}function resetModel(){_nodeStore={},_nodeLookup={}}function saveNode(node){updateMacro(node),setNode(node),setNodeLookup(node)}function setNode(node){_nodeStore[node.getUUID()]=node}function setNodeLookup(node){var params=node.getParams().settings,prefix=getCurrentMacroNamespace(),selector_array=[];if(__.isObj(params))for(var x in params)if("id"===x)selector_array.push(prefix+"#"+params[x]),setter(_nodeLookup,prefix+"#"+params[x],node.getUUID());else if("class"===x){var classArr=params[x].split(",");classArr.forEach(function(){selector_array.push(prefix+"."+params[x]),setter(_nodeLookup,prefix+"."+params[x],node.getUUID())})}selector_array.push("*"),setter(_nodeLookup,"*",node.getUUID()),selector_array.push(prefix+node.getType()),setter(_nodeLookup,prefix+node.getType(),node.getUUID()),node.selector_array=selector_array}function removeModelReferences(nodes){function removeReferences(node){var uuid=node;if(node=getNodeWithUUID(uuid)){var arr=node.selector_array;if(__.isArr(arr)&&arr.forEach(function(selector){unsetter(_nodeLookup,selector,uuid),unsetter(_nodeStore,uuid,null)}),node.isMacro()){node.getNativeNode().forEach(function(nativeNode){removeReferences(nativeNode.uuid)})}}}(nodes||_selectedNodes).forEach(removeReferences)}function getNodeWithUUID(uuid){return uuid&&_nodeStore[uuid]?_nodeStore[uuid]:uuid&&__.isObj(uuid)&&"AudioNode"===uuid.constructor.name?uuid:__.isObj(uuid)&&__.isNotUndef(uuid.uuid)?getNodeWithUUID(uuid.uuid):null}function getNodesWithSelector(selector){var selector_array=selector.split(","),nodes=[];return selector_array.forEach(function(currSelector,i,array){if(currSelector&&_nodeLookup[currSelector]){var tmp=_nodeLookup[currSelector];tmp="id"===getSelectorType(currSelector)&&__.isArr(tmp)&&tmp.length>1?[tmp[0]]:tmp,nodes=arrayUnique(nodes.concat(tmp))}}),nodes}function getPreviousNode(){return _previousNode}function setPreviousNode(node){node&&(_previousNode=node)}function getSelectorType(str){return str.match(/^\./)?"class":str.match(/^\#/)?"id":"type"}function createMacro(name,userParams){return createNode(name,{method:"createMacro",settings:{}},userParams)}function updateMacro(node){recordingMacro()&&(node.setMacroContainerUUID(getCurrentMacro().getUUID()),getCurrentMacro().addNativeNode(node.getNativeNode()))}function recordingMacro(){return!!_currentMacro.length}function getCurrentMacro(){return recordingMacro()?_currentMacro[_currentMacro.length-1]:null}function getCurrentMacroNamespace(){var arr=[];if(recordingMacro())for(var i=0;i<_currentMacro.length;i++)arr.push(_currentMacro[i].getType()),arr.push(" ");return arr.join("")}function resetMacro(){_currentMacro=[]}function connectPreviousToSelected(){var pNode=getPreviousNode();_selectedNodes.forEach(function(node,i,array){(node=getNodeWithUUID(node))&&pNode&&(pNode.connect(node),pNode.pushNextNode(node),node.setPrevNode(pNode),logConnections(pNode,node))})}function flatten(a,r){r=r||[];for(var i=0;i<a.length;i++)a[i].constructor===Array?flatten(a[i],r):r.push(a[i]);return r}function arrayUnique(array){for(var a=array.concat(),i=0;i<a.length;++i)for(var j=i+1;j<a.length;++j)a[i]===a[j]&&a.splice(j--,1);return a}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0;return("x"===c?r:3&r|8).toString(16)})}function setter(map,key,value){map&&key&&(map[key]&&map[key].push?map[key].push(value):map[key]=[value])}function unsetter(map,key,value){__.isNotUndef(map[key])&&(__.isArr(map[key])?(map[key]=map[key].filter(function(val){return value!==val}),0===map[key].length&&delete map[key]):delete map[key])}function mergeObjects(source,target){source=source||{},target=target||{};for(var x in source)source.hasOwnProperty(x)&&(target[x]=source[x]);return target}function logNodes(node,arr){if(_currentSelector){var nodes=arr||[];(node||_selectedNodes).forEach(function(nodeID,i,array){var tmp=getNodeWithUUID(nodeID).getNativeNode();__.isArr(tmp)&&logNodes(tmp,nodes),array===_selectedNodes&&nodes.push(tmp)})}}function logToConsole(msg){_debugEnabled&&console.log(msg)}function logConnections(nodeToConnect,node){var vals=[nodeToConnect.getType(),nodeToConnect.getID(),node.getType(),node.getID()];logToConsole("connected "+vals[0]+" - "+vals[1]+" to "+vals[2]+" - "+vals[3])}var _nodeStore={},_nodeLookup={},_previousNode=null,_selectedNodes=[],_currentSelector="",_currentMacro=[],_debugEnabled=!1,_context=window.AudioContext?new AudioContext:new webkitAudioContext,_maxChannelCount=_context.destination.maxChannelCount,cracked=find;cracked.reset=function(){return __("*").remove(),resetMacro(),reset(),resetModel(),resetLoop(),cracked},cracked.exec=function(method,args,nodes){var save=_selectedNodes;return _selectedNodes=nodes,cracked[method].apply(cracked,args),_selectedNodes=save,cracked},cracked.each=function(type,fn){if(__.isFun(fn))for(var i=0;i<_selectedNodes.length;i++){var node=getNodeWithUUID(_selectedNodes[i]);(!type||type&&node.getType()===type)&&fn(node,i,_selectedNodes)}return cracked},cracked.filter=function(){var tmp=[];if(arguments&&arguments.length){var str=arguments[0],selectorType=getSelectorType(str),match=str.match(/^\.|\#/)?str.substring(1):str;_selectedNodes.forEach(function(nodeID,i,arr){var node=getNodeWithUUID(nodeID);("type"===selectorType&&node.getType()===match||"class"===selectorType&&node.getClass()===match||"id"===selectorType&&node.getID()===match)&&tmp.push(nodeID)})}return tmp},cracked.find=function(){return getNodesWithSelector(recordingMacro()?processSelectorForMacro(arguments[0]):arguments[0])},cracked.start=function(){function _start(){if(!recordingMacro())for(var i=0;i<_selectedNodes.length;i++){var currNode=getNodeWithUUID(_selectedNodes[i]);currNode&&!currNode.getIsPlaying()&&currNode.start()}}return"suspended"===_context.state?_context.resume().then(function(){_start()}):_start(),cracked},cracked.stop=function(){for(var i=0;i<_selectedNodes.length;i++){var currNode=getNodeWithUUID(_selectedNodes[i]);currNode&&currNode.getIsPlaying()&&currNode.stop(0)}return cracked},cracked.ramp=function(target,timeToRamp,paramToRamp,initial,type){for(var mapParam=function(node,param){var mappingResult="";if(node.getParamMapping){mappingResult=(node.getParamMapping()||{})[param]||"",-1!==mappingResult.indexOf(".")&&(mappingResult=mappingResult.split(".")[0])}return mappingResult},i=0;i<_selectedNodes.length;i++){for(var currNode=getNodeWithUUID(_selectedNodes[i]),native=currNode.isMacro()?currNode.getNativeNode():[currNode.getNativeNode()],mappedParam="",z=0;z<native.length;z++){var nativeWrapper=getNodeWithUUID(native[z].uuid);if(nativeWrapper&&(mappedParam=mapParam(nativeWrapper,paramToRamp)))break}currNode&&currNode.ramp(target,timeToRamp,mappedParam||paramToRamp,null,initial,type)}return cracked},cracked.attr=function(userParams){if("object"==typeof userParams)for(var i=0;i<_selectedNodes.length;i++){var currNode=getNodeWithUUID(_selectedNodes[i]);currNode&&userParams&&currNode.attr(userParams)}else if("string"==typeof userParams&&_selectedNodes.length&&getNodeWithUUID(_selectedNodes[0]))return getNodeWithUUID(_selectedNodes[0]).getAttr(userParams);return cracked},cracked.script=function(userParams){function defaultFunction(e){for(var input=e.inputBuffer.getChannelData(0),output=e.outputBuffer.getChannelData(0),i=0;i<buffersize;i++)output[i]=input[i]}userParams=userParams||{};var buffersize=userParams.buffersize||4096,channels=userParams.channels||1,fn=userParams.fn||defaultFunction;return createNode("script",{method:"createScriptProcessor",methodParams:[buffersize,channels,channels],settings:{onaudioprocess:fn}},userParams),cracked},cracked.waveshaper=function(userParams){function makeCurve(amount){for(var x,k=__.isNum(amount)?amount:50,n_samples=44100,curve=new Float32Array(n_samples),deg=Math.PI/180,i=0;i<n_samples;++i)x=2*i/n_samples-1,curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x));return curve}userParams=userParams||{};var drive=__.isObj(userParams)?cracked.ifUndef(userParams.drive,50):userParams;return createNode("waveshaper",{method:"createWaveShaper",settings:{curve:userParams.curve||makeCurve(drive),mapping:{distortion:{path:"curve",fn:function(){return makeCurve}()}}}},userParams),cracked},cracked.compressor=function(userParams){return createNode("compressor",{method:"createDynamicsCompressor",settings:{},mapping:{threshold:"threshold.value",knee:"knee.value",ratio:"ratio.value",attack:"attack.value",release:"release.value"}},userParams),cracked},cracked.gain=function(userParams){var gain=__.isNum(userParams)?userParams:1;return createNode("gain",{method:"createGain",settings:{},mapping:{gain:"gain.value"}},__.isObj(userParams)?userParams:{gain:gain}),cracked},cracked.native_delay=function(userParams){return createNode("delay",{method:"createDelay",methodParams:[179],settings:{},mapping:{delay:"delayTime.value"}},userParams),cracked},cracked.osc=function(userParams){return createNode("osc",{method:"createOscillator",settings:{},mapping:{frequency:"frequency.value",detune:"detune.value"}},userParams),cracked},cracked.biquadFilter=function(userParams){return createNode("biquadFilter",{method:"createBiquadFilter",settings:{},mapping:{q:"Q.value",frequency:"frequency.value",gain:"gain.value"}},userParams),cracked},cracked.channelMerger=function(userParams){return _maxChannelCount>2&&(_context.destination.channelCount=_maxChannelCount,_context.destination.channelCountMode="explicit",_context.destination.channelInterpretation="discrete"),createNode("channelMerger",{method:"createChannelMerger",methodParams:[__.isNum(userParams)?userParams:__.isObj(userParams)&&userParams.channels?userParams.channels:_context.destination.maxChannelCount],settings:{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"}},userParams),cracked},cracked.channelSplitter=function(userParams){return userParams=userParams||2,createNode("channelSplitter",{method:"createChannelSplitter",methodParams:[__.isNum(userParams)?userParams:__.isObj(userParams)&&userParams.channels?userParams.channels:2],settings:{}},userParams),cracked},cracked.convolver=function(userParams){return userParams=userParams||{},loadBuffer(userParams,createNode("convolver",{method:"createConvolver",settings:{}},userParams)),cracked},cracked.stereoPanner=function(userParams){return userParams=userParams||{},createNode("stereoPanner",{mapping:{pan:"pan.value"},method:"createStereoPanner",settings:{}},userParams),cracked},cracked.destination=function(userParams){return createNode("destination",{method:"createDestination",settings:{}},userParams),cracked},cracked.origin=function(userParams){var cParams={method:"createOrigin",settings:{}};return createMediaStreamSourceNode(cParams,createNode("origin",cParams,userParams)),cracked},cracked.buffer=function(userParams){return loadBuffer(userParams,createNode("buffer",{method:"createBufferSource",settings:{},mapping:{speed:"playbackRate.value",start:"loopStart",end:"loopEnd",duration:"buffer.duration"}},userParams)),cracked};var _isLoopRunning=!1,_ignoreGrid=!0,_loopStepSize=0,_loopInterval=100,_loopCB=null,_loopData=[],_loopIndex=-1,_loopCount=0,_loopListeners=[],_loopTimeToNextStep=0,_loopTolerance=.3,_timerWorker=null;cracked.loop=function(){return arguments&&arguments.length&&("stop"===arguments[0]?stopLoop():"start"===arguments[0]?startLoop():"reset"===arguments[0]?resetLoop():"toggle_grid"===arguments[0]?toggleGrid():3===arguments.length&&__.isObj(arguments[0])&&__.isFun(arguments[1])&&__.isArr(arguments[2])?configureLoop(arguments[0],arguments[1],arguments[2]):1===arguments.length&&__.isNum(arguments[0])?configureLoop(arguments[0]):1===arguments.length&&__.isObj(arguments[0])?configureLoop(arguments[0]):2===arguments.length&&__.isNum(arguments[0])&&__.isFun(arguments[1])?configureLoop({interval:arguments[0]},arguments[1],[]):3!==arguments.length||arguments[0]||arguments[1]||!__.isArr(arguments[2])||configureLoop(arguments[0],arguments[1],arguments[2])),cracked},cracked.bind=function(eventType,fn,data){return"step"===eventType&&__.isFun(fn)&&_loopListeners.push({eventType:eventType,callback:fn,data:data||[],loopStepSize:data.length||0,loopIndex:-1,selection:_selectedNodes.slice(0),selector:_currentSelector,count:0}),cracked},cracked.unbind=function(eventType){if("step"===eventType){var tmp=[];_loopListeners.forEach(function(el,i,arr){_currentSelector!==el.selector&&tmp.push(el)}),_loopListeners=tmp}},cracked.removeMacros=function(){for(var arr=_currentSelector.split(","),i=0;i<arr.length;i++)if(_nodeLookup[arr[i]])for(var keyArr=Object.keys(_nodeLookup),j=0;j<keyArr.length;j++){var re=new RegExp(arr[i]+"\\s*");if(keyArr[j].match(re)){for(var tmp=_nodeLookup[keyArr[j]],k=0;k<tmp.length;k++){delete _nodeStore[[keyArr[j]][k]];var index=_nodeLookup["*"].indexOf(_nodeLookup[keyArr[j]][k]);index>-1&&_nodeLookup["*"].splice(index,1)}delete _nodeLookup[keyArr[j]]}}},cracked.begin=function(name,userParams){return name&&_currentMacro.push(createMacro(name,userParams)),cracked},cracked.end=function(name){return recordingMacro()&&getCurrentMacro().getType()===name&&(getCurrentMacro().setMacroNameSpace(getCurrentMacroNamespace()),_currentMacro.pop()),cracked};var _midi_access=null,_midi_inputs=null,_midi_outputs=null,_midi_callbacks={noteon:function(){},noteoff:function(){},control:function(){}},_midi_noteons={};cracked.midi_supported=function(){return"function"==typeof navigator.requestMIDIAccess},cracked.midi_init=function(callback){_midi_access?callback.apply(cracked,[!0]):__.midi_supported()?navigator.requestMIDIAccess().then(function(access){_midi_access=access,_midi_inputs=access.inputs,_midi_outputs=access.outputs,callback.apply(cracked,[!0])},function(err){console.error("midi_init: Initialization failed. Error code: "+err.code),callback.apply(cracked,[!1])}):(console.error("midi_init: Failed. Midi not supported by your browser"),callback.apply(cracked,[!1]))},cracked.midi_receive=function(callback){if(_midi_access)for(var fun=__.isFun(callback)?callback:function(){},inputs=_midi_inputs.values(),input=inputs.next();input&&!input.done;input=inputs.next())input.value.onmidimessage=function(ev){if(ev.data){var status=ev.data[0],pitch=ev.data[1],velocity=ev.data[2],note_data=[status,pitch,velocity];switch(fun(ev),status){case 144:velocity>0?_midi_noteons[pitch]||(_midi_noteons[pitch]=pitch,_midi_callbacks.noteon(note_data)):(_midi_callbacks.noteoff(note_data),delete _midi_noteons[pitch]);break;case 128:_midi_callbacks.noteoff(note_data),delete _midi_noteons[pitch];break;case 176:_midi_callbacks.control(note_data)}}};else console.error("midi_receive: midi not available")},cracked.midi_noteon=function(callback){__.isFun(callback)&&(_midi_callbacks.noteon=callback,cracked.midi_receive())},cracked.midi_noteoff=function(callback){__.isFun(callback)&&(_midi_callbacks.noteoff=callback,cracked.midi_receive())},cracked.midi_control=function(callback){__.isFun(callback)&&(_midi_callbacks.control=callback,cracked.midi_receive())},cracked.connect=function(){var tmp=getPreviousNode();return!tmp&&_selectedNodes.length&&(tmp=getNodeWithUUID(_selectedNodes[0])),find(arguments[0]),setPreviousNode(tmp),connectPreviousToSelected(),cracked},cracked.remove=function(time){function _remove(nodes){nodes.forEach(function(node,i,array){(node=getNodeWithUUID(node))&&(node.stop(),node.disconnect())}),removeModelReferences(nodes)}var nodesToRemove=_selectedNodes.slice(),when=__.isNum(time)?time:0;when?setTimeout(function(){_remove(nodesToRemove)},when):_remove(nodesToRemove)},cracked.log=function(){var arr=[];logNodes(null,arr),console.log(arr)},cracked.size=function(){return _selectedNodes.length?_selectedNodes.length:0},function(){-1!==window.location.href.indexOf("debug=true")&&(_debugEnabled=!0)}(),cracked._dumpState=function(){console.log(_nodeLookup,_nodeStore)},cracked._getNode=function(uuid){return getNodeWithUUID(uuid)},window.cracked=cracked,window.__=window.__||cracked,cracked.ifUndef=function(test,def){return void 0===test?def:test},cracked.isNotUndef=function(test){return void 0!==test},cracked.isUndef=function(test){return void 0===test},cracked.isObj=function(obj){return obj&&"object"==typeof obj},cracked.isNum=function(num){return null!==num&&""!==num&&void 0!==num&&!isNaN(num)},cracked.isStr=function(str){return str&&"string"==typeof str},cracked.isArr=function(arr){return arr&&arr instanceof Array},cracked.isFun=function(fn){return fn&&fn instanceof Function},cracked.random_interval=function(callback,minTime,maxTime){function set_timeout(callback,minTime,maxTime,ran){var nextRan=cracked.random(minTime,maxTime);setTimeout(function(){callback(nextRan),set_timeout(callback,minTime,maxTime,nextRan)},ran)}"function"==typeof callback&&__.isNum(minTime)&&__.isNum(maxTime)&&set_timeout(callback,minTime,maxTime,cracked.random(minTime,maxTime))},cracked.random_envelope=function(length){var result=[];if(__.isNum(length)){var tmp=__.fill_array(4,function(){return __.random(0,100)}),sum=tmp.reduce(function(a,b){return a+b}),factor=length/sum;result=tmp.map(function(element,index){return element*factor})}return result},cracked.fill_array=function(size,fn){var tmp=[];if(__.isNum(size))for(var fun=__.isFun(fn)?fn:function(){return 0},i=0;i<size;i++)tmp.push(fun.apply(this,[i]));return tmp},cracked.array_next=function(arr,offset,limit,callback){offset=offset||0,limit=limit||arr.length;var adjusted_limit=Math.min(limit,arr.length),adjusted_offset=Math.min(offset,adjusted_limit-1),old_index=arr.current_index=__.ifUndef(arr.current_index,-1);return arr.current_index=arr.current_index+1+adjusted_offset>=adjusted_limit?0:arr.current_index+1,old_index>arr.current_index&&"function"==typeof callback&&callback(),arr[arr.current_index+adjusted_offset]},cracked.chance=function(percentage){return percentage>__.random(0,99)},cracked.scales=function(type){return{major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],wholetone:[0,2,4,6,8,10],overtone:[0,2,4,6,7,9,10],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],ionian:[0,2,4,5,7,9,11]}[type]},cracked.chords=function(type){return{major:[0,4,7],minor:[0,3,7],seventh:[0,4,7,10],ninth:[0,4,7,10,14],major_seventh:[0,4,7,11],minor_seventh:[0,3,7,10],suspended:[0,5,7],diminished:[0,3,6],eleventh:[0,4,7,10,14,17],thirteenth:[0,4,7,10,14,17,21]}[type]},cracked.random_scale=function(scale,octave_lower,octave_upper){var lower=__.ifUndef(octave_lower,3),upper=__.ifUndef(octave_upper,7);return __.pitch2freq(__.scales(scale)[__.random(0,__.scales(scale).length-1)]+12*__.random(lower,upper))},cracked.random_arpeggio=function(chord,octave_lower,octave_upper){var lower=__.ifUndef(octave_lower,3),upper=__.ifUndef(octave_upper,7);return __.pitch2freq(__.chords(chord)[__.random(0,__.chords(chord).length-1)]+12*__.random(lower,upper))},cracked.shuffle=function(arr){for(var temp,index,counter=arr.length;counter>0;)index=Math.floor(Math.random()*counter),counter--,temp=arr[counter],arr[counter]=arr[index],arr[index]=temp;return arr},cracked.urnFactory=function(max){for(var arr=[];arr.length<max;){var r=Math.floor(Math.random()*max);-1===arr.indexOf(r)&&arr.push(r)}return function(){return cracked.array_next(arr)}},cracked.random=function(min,max){return Math.round(min+Math.random()*(max-min))},cracked.throttle_factory=function(num){var index=0,number=num;return function(){return++index%number==0}},cracked.__sequence_storage={},cracked.sequence=function(name){return cracked.__sequence_storage[name]||(cracked.__sequence_storage[name]={steps:{}}),function(name){return{step:function(func,time){return cracked.__sequence_storage[name].steps[time.toString()]=func,this},start:function(){cracked.__sequence_storage[name].startTime=Date.now(),cracked.__sequence_storage[name].clearInterval=setInterval(function(){var time_elapsed=Date.now()-cracked.__sequence_storage[name].startTime,steps=Object.keys(cracked.__sequence_storage[name].steps);steps.length?steps.map(function(x){time_elapsed>=6e4*x&&(cracked.__sequence_storage[name].steps[x](),delete cracked.__sequence_storage[name].steps[x])}):clearInterval(cracked.__sequence_storage[name].clearInterval)},1e3)},stop:function(){clearInterval(cracked.__sequence_storage[name].clearInterval)}}}(name)},cracked.reverb=function(params){function buildImpulse(audioContext){var n,i,rate=audioContext.sampleRate,length=rate*_seconds,decay=_decay,impulse=audioContext.createBuffer(2,length,rate),impulseL=impulse.getChannelData(0),impulseR=impulse.getChannelData(1);for(i=0;i<length;i++)n=_reverse?length-i:i,impulseL[i]=(2*Math.random()-1)*Math.pow(1-n/length,decay),impulseR[i]=(2*Math.random()-1)*Math.pow(1-n/length,decay);return impulse}params=__.ifUndef(params,{}),params.path||(params.fn=params.fn||buildImpulse);var _seconds=__.ifUndef(params.seconds,3),_reverse=__.ifUndef(params.reverse,!1),_decay=__.ifUndef(params.decay,2);return __.begin("reverb",params).convolver(params).end("reverb"),cracked},cracked.delay=function(params){params=__.ifUndef(params,{});var time=__.isObj(params)?__.ifUndef(params.delay,1):params;return __.begin("delay",params),__.gain({id:"delay-input"}).native_delay({id:"native-delay",delay:time,mapping:{delay:"delayTime.value"}}).gain({id:"delay-damping",gain:__.ifUndef(params.damping,.84),mapping:{damping:"gain.value"}}).lowpass({id:"delay-cutoff",frequency:__.ifUndef(params.cutoff,1500),mapping:{cutoff:"frequency.value"}}).gain({id:"delay-feedback",gain:__.ifUndef(params.feedback,.5),mapping:{feedback:"gain.value"}}).gain({id:"delay-output"}),__("#delay-feedback").connect("#delay-input"),__("#native-delay").gain(.5).connect("#delay-output"),__.end("delay"),cracked},cracked.comb=function(params){var userParams=__.ifUndef(params,{});return __.begin("comb",userParams),__.gain({id:"comb-input"}).native_delay({id:"comb-delay",delay:__.ifUndef(userParams.delay,.027),mapping:{delay:"delayTime.value"}}).gain({id:"comb-damping",gain:__.ifUndef(userParams.damping,.84),mapping:{damping:"gain.value"}}).lowpass({id:"comb-cutoff",frequency:__.ifUndef(userParams.cutoff,3e3),mapping:{cutoff:"frequency.value"}}).gain({id:"comb-feedback",gain:__.ifUndef(userParams.feedback,.84),mapping:{feedback:"gain.value"}}).connect("#comb-input"),__("#comb-damping").gain({id:"output"}),__.end("comb"),cracked},cracked.bitcrusher=function(params){return params=params||{},__.begin("bitcrusher",params),__.script({fn:function(options){function crusher(e){for(var input=e.inputBuffer.getChannelData(0),output=e.outputBuffer.getChannelData(0),i=0;i<4096;i++)phaser+=normfreq,phaser>=1&&(phaser-=1,last=step*Math.floor(input[i]/step+.5)),output[i]=last}var bits=options.bits||6,normfreq=__.ifUndef(options.frequency,.1),step=Math.pow(.5,bits),phaser=0,last=0;return crusher}(params)}),__.end("bitcrusher"),cracked},cracked.ring=function(params){function setCurve(distortion){var i,samples,v,value,wsCurve,_i,_ref,vb,vl,h;for(vb=.2,vl=.4,h=__.ifUndef(distortion,1),samples=1024,wsCurve=new Float32Array(samples),i=_i=0,_ref=wsCurve.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)v=(i-samples/2)/(samples/2),v=Math.abs(v),value=v<=vb?0:vb<v&&v<=vl?h*(Math.pow(v-vb,2)/(2*vl-2*vb)):h*v-h*vl+h*(Math.pow(vl-vb,2)/(2*vl-2*vb)),wsCurve[i]=value;return wsCurve}var options=params||{},thisCurve=setCurve(__.ifUndef(options.distortion,1));return __.begin("ring",params),__.gain({id:"player"}).gain({id:"vcInverter1",gain:-1}).waveshaper({id:"vcDiode3",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).compressor({threshold:-12}),__("#player").waveshaper({id:"vInDiode4",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).connect("compressor"),__().sine({id:"vIn",frequency:options.frequency||30,mapping:{frequency:"frequency.value"}}).gain({id:"vInGain",gain:.5}).gain({id:"vInInverter1",gain:-1}).gain({id:"vInInverter2",gain:-1}).waveshaper({id:"vInDiode1",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).gain({id:"vInInverter3",gain:-1}).connect("compressor"),__("#vInGain").connect("#vInDiode4"),__("#vInGain").connect("#vcInverter1"),__("#vInInverter1").waveshaper({id:"vInDiode2",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).connect("#vInInverter3"),__("compressor").gain({id:"outGain",gain:4}),__.end("ring"),cracked},cracked.overdrive=function(params){function makeCurve(value){for(var k=100*value,n=22050,curve=new Float32Array(n),deg=Math.PI/180,i=0;i<n;i++){var x=2*i/n-1;curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x))}return curve}params=params||{};var drive=__.isObj(params)?__.ifUndef(params.drive,.5):params;return __.begin("overdrive",params),__.gain({id:"input"}).bandpass({frequency:__.ifUndef(params.color,800),mapping:{color:"frequency.value"}}).waveshaper({curve:makeCurve(drive),mapping:{drive:{path:"curve",fn:function(){return makeCurve}()}}}).lowpass({frequency:__.ifUndef(params.postCut,3e3),mapping:{postCut:"frequency.value"}}).gain({id:"output"}),__.end("overdrive"),cracked},cracked.adsr=function(userParams){function makeEnv(userParams,nodeParams){var segment,args=userParams||nodeParams,p=[0,0,0,0,0],options=args||.5;if(__.isArr(options))if(5===options.length)p=options;else if(4===options.length){var sum=options[0]+options[1]+options[3];p=[options[0],options[1],options[2],sum/3,options[3]]}else 3===options.length&&(p=[options[0],options[1],options[2],7200,0]);else __.isNum(options)?(segment=options/4,p=[segment,segment,.5,segment,segment]):__.isStr(options)&&(options="slow"===options?1:"fast"===options?.25:.5,segment=options/4,p=[segment,segment,.5,segment,segment]);return p}var methods={init:function(options){options=options||{},options=__.isNum(options)||__.isArr(options)||__.isStr(options)?{envelope:options}:options,__.begin("adsr",options).gain({gain:0}).end("adsr")},trigger:function(params){cracked.each("adsr",function(el,i,arr){var p=makeEnv(params,el.getParams().settings.envelope);el.ramp([1,p[2],p[2],0],[p[0],p[1],p[3],p[4]],"gain",null,0)})},release:function(time){time=__.ifUndef(time,0),cracked.each("adsr",function(el,i,arr){el.ramp(0,time,"gain")})}};return methods[userParams]?methods[userParams].apply(this,Array.prototype.slice.call(arguments,1)):methods.init(userParams),cracked},cracked.lowpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"lowpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("lowpass",userParams).biquadFilter(options).end("lowpass"),cracked},cracked.highpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"highpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("highpass",userParams).biquadFilter(options).end("highpass"),cracked},cracked.bandpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"bandpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("bandpass",userParams).biquadFilter(options).end("bandpass"),cracked},cracked.lowshelf=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"lowshelf",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.gain=__.ifUndef(userParams.gain,0),options.mapping=userParams.mapping||{},__.begin("lowshelf",userParams).biquadFilter(options).end("lowshelf"),cracked},cracked.highshelf=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"highshelf",options.frequency=userParams.frequency||freq,options.gain=__.ifUndef(userParams.gain,0),options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("highshelf",userParams).biquadFilter(options).end("highshelf"),cracked},cracked.peaking=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"peaking",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.gain=__.ifUndef(userParams.gain,0),options.mapping=userParams.mapping||{},__.begin("peaking",userParams).biquadFilter(options).end("peaking"),cracked},cracked.notch=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"notch",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,10),options.mapping=userParams.mapping||{},__.begin("notch",userParams).biquadFilter(options).end("notch"),cracked},cracked.allpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"allpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,10),options.mapping=userParams.mapping||{},__.begin("allpass",userParams).biquadFilter(options).end("allpass"),cracked},cracked.mouse_movement=function(callback){function moveHandler(e){callback&&callback(e)}window.parent.document.removeEventListener("mousemove",moveHandler,!1),window.parent.document.addEventListener("mousemove",moveHandler,!1)},cracked.key_press=function(callback){function keyPressHandler(e){callback&&callback(e)}window.parent.document.removeEventListener("keypress",keyPressHandler,!1),window.parent.document.addEventListener("keypress",keyPressHandler,!1)},cracked.clip=function(params){var userParams=__.isObj(params)?params:{};userParams.mapping=userParams.mapping||{};var curve=new Float32Array(2);return curve[0]=-1,curve[1]=1,__.begin("clip",userParams).waveshaper({curve:curve}).end("clip"),cracked},cracked.dac=function(params){var gain=__.isNum(params)?params:1,userParams=__.isObj(params)?params:{};return userParams.mapping=userParams.mapping||{},gain>1?__.begin("dac",userParams).gain(gain).destination().end("dac"):__.begin("dac",userParams).clip().gain(gain).destination().end("dac"),cracked},cracked.adc=function(params){var gain=__.isNum(params)?params:1,userParams=__.isObj(params)?params:{};return userParams.mapping=userParams.mapping||{},__.begin("adc",userParams).origin().gain(gain).end("adc"),cracked},cracked.out=function(params){var gain=__.isNum(params)?params:1,userParams=__.isObj(params)?params:{};return userParams.mapping=userParams.mapping||{},__.begin("out",userParams).gain(gain).destination().end("out"),cracked},cracked.multi_out=function(params){var to_channel=__.isNum(params)?params:__.isObj(params)&&params.channel?params.channel:0,userParams=__.isObj(params)?params:{},gain=userParams.gain?userParams.gain:1;return userParams.mapping=userParams.mapping||{},__.begin("multi_out",userParams).gain({from_channel:0,to_channel:to_channel,gain:gain}).channelMerger().destination().end("multi_out"),cracked},cracked.in=function(params){var gain=__.isNum(params)?params:1,userParams=__.isObj(params)?params:{};return userParams.mapping=userParams.mapping||{},__.begin("in",userParams).origin().gain(gain).end("in"),cracked},cracked.panner=function(params){var pan=__.isNum(params)?params:__.isObj(params)&&params.pan?params.pan:0,userParams=__.isObj(params)?params:{};return userParams.mapping=userParams.mapping||{},__.begin("panner",userParams).stereoPanner({pan:pan}).end("panner"),cracked},cracked.sampler=function(userParams){return userParams&&userParams.path&&__.begin("sampler",userParams).buffer(userParams).end("sampler"),cracked},cracked.lfo=function(userParams){var params=userParams||{};return params.modulates=params.modulates||"frequency","white"===params.type||"pink"===params.type||"brown"===params.type?__.begin("lfo",params).noise({type:params.type||"white",channels:1,length:params.length||1}).gain({gain:__.ifUndef(params.gain,1e3)}).end("lfo"):__.begin("lfo",params).osc({type:params.type||"sawtooth",frequency:params.frequency||6}).gain({gain:__.ifUndef(params.gain,1e3)}).end("lfo"),cracked},cracked.stepper=function(params){function buildBuffer(audioContext){var buffer=audioContext.createBuffer(1,length*audioContext.sampleRate,audioContext.sampleRate),buflen=buffer.length,buffArr=[],stepSize=Math.floor(buflen/steps),stepCount=0,value=0;buffArr.push(buffer.getChannelData(0));for(var i=0;i<buflen;i++)value=!i||i%stepSize==0&&stepCount<steps?function(){return stepCount++,fn()}():value,buffArr[0][i]=value;return buffer}var userParams=params||{},length=userParams.length||1,steps=userParams.steps||8,fn=userParams.fn||function(){return __.random(-100,100)/100};userParams.modulates=params.modulates||"frequency";var step_size=length/steps,bufferParams={fn:buildBuffer,loop:!0},start_point=userParams.start*step_size||0,end_point=userParams.end*step_size||0;return start_point&&(bufferParams.start=start_point),end_point&&(bufferParams.end=end_point),__().begin("stepper",userParams).buffer(bufferParams).gain({gain:__.ifUndef(params.gain,1e3)}).end("stepper"),cracked},cracked.noise=function(params){var userParams=params||{};return"brown"===userParams.type?__.begin("noise",userParams).brown(userParams).end("noise"):"pink"===userParams.type?__.begin("noise",userParams).pink(userParams).end("noise"):__.begin("noise",userParams).white(userParams).end("noise"),cracked},cracked.pink=function(params){function buildBuffer(audioContext){function pinkify(buf,buffArr){var channelData,white,i,j,buffer=buf,b=[0,0,0,0,0,0,0],pink=[],bufNum=buffer.numberOfChannels,buflen=buffer.length;for(i=0;i<bufNum;i++){for(pink[i]=new Float32Array(buflen),channelData=buffArr[i],j=0;j<buflen;j++)white=channelData[j],b[0]=.99886*b[0]+.0555179*white,b[1]=.99332*b[1]+.0750759*white,b[2]=.969*b[2]+.153852*white,b[3]=.8665*b[3]+.3104856*white,b[4]=.55*b[4]+.5329522*white,b[5]=-.7616*b[5]-.016898*white,pink[i][j]=b[0]+b[1]+b[2]+b[3]+b[4]+b[5]+b[6]+.5362*white,pink[i][j]*=.11,b[6]=.115926*white;b=[0,0,0,0,0,0,0]}for(i=0;i<bufNum;i++)for(j=0;j<buflen;j++)buffArr[i][j]=pink[i][j]}for(var buf=audioContext.createBuffer(channels,length*audioContext.sampleRate,audioContext.sampleRate),buflen=buf.length,bufNum=buf.numberOfChannels,buffArr=[],k=0;k<bufNum;k++)buffArr.push(buf.getChannelData(k));for(var i=0;i<buflen;i++)for(var j=0;j<bufNum;j++)buffArr[j][i]=2*Math.random()-1;return pinkify(buf,buffArr),buf}var userParams=params||{},channels=userParams.channels||1,length=userParams.length||1;return __().begin("pink",userParams).buffer({fn:buildBuffer,loop:!0}).end("pink"),cracked},cracked.white=function(params){function buildBuffer(audioContext){for(var buffer=audioContext.createBuffer(channels,length*audioContext.sampleRate,audioContext.sampleRate),buflen=buffer.length,bufNum=buffer.numberOfChannels,buffArr=[],k=0;k<bufNum;k++)buffArr.push(buffer.getChannelData(k));for(var i=0;i<buflen;i++)for(var j=0;j<bufNum;j++)buffArr[j][i]=.44*(2*Math.random()-1);return buffer}var userParams=params||{},channels=userParams.channels||1,length=userParams.length||1;return __().begin("white",userParams).buffer({fn:buildBuffer,loop:!0}).end("white"),cracked},cracked.brown=function(params){function buildBuffer(audioContext){for(var buffer=audioContext.createBuffer(channels,length*audioContext.sampleRate,audioContext.sampleRate),lastOut=0,bufLen=buffer.length,bufNum=buffer.numberOfChannels,buffArr=[],k=0;k<bufNum;k++)buffArr.push(buffer.getChannelData(k));for(var i=0;i<bufLen;i++)for(var j=0;j<bufNum;j++){var white=2*Math.random()-1;buffArr[j][i]=(lastOut+.02*white)/1.02,lastOut=buffArr[j][i],buffArr[j][i]*=3.5}return buffer}var userParams=params||{},channels=userParams.channels||1,length=userParams.length||1;return __().begin("brown",userParams).buffer({fn:buildBuffer,loop:!0}).end("brown"),cracked},cracked.sine=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"sine",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("sine",userParams).osc(options).end("sine"),cracked},cracked.square=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"square",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("square",userParams).osc(options).end("square"),cracked},cracked.saw=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"sawtooth",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("saw",userParams).osc(options).end("saw"),cracked},cracked.triangle=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"triangle",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("triangle",userParams).osc(options).end("triangle"),cracked},cracked.frequency=function(userParam){return __.isNum(userParam)&&cracked.attr({frequency:userParam}),cracked},cracked.detune=function(userParam){return __.isNum(userParam)&&cracked.attr({detune:userParam}),cracked},cracked.type=function(userParam){return __.isStr(userParam)&&cracked.attr({type:userParam}),cracked},cracked.volume=function(userParam){return __.isNum(userParam)&&cracked.attr({gain:userParam}),cracked},cracked.fadeOut=function(userParam){var num=__.isNum(userParam)?userParam:.02;return cracked.ramp(0,num,"gain"),cracked},cracked.fadeIn=function(userParam){var num=__.isNum(userParam)?userParam:.02;return cracked.ramp(1,num,"gain"),cracked},cracked.time=function(userParam){return __.isNum(userParam)&&cracked.attr({delay:userParam}),cracked},cracked.feedback=function(userParam){return __.isNum(userParam)&&cracked.attr({feedback:userParam}),cracked},cracked.speed=function(userParam){return __.isNum(userParam)&&cracked.attr({speed:userParam}),cracked},cracked.drive=function(userParam){return __.isNum(userParam)&&cracked.attr({drive:userParam}),cracked},cracked.distortion=function(userParam){return __.isNum(userParam)&&cracked.attr({distortion:userParam}),cracked},cracked.q=function(userParam){return __.isNum(userParam)&&cracked.attr({q:userParam}),cracked},cracked.pan=function(userParam){return __.isNum(userParam)&&cracked.attr({pan:userParam}),cracked},cracked.gang_of_oscillators=function(params){var type=__.isStr(params)?params:__.isObj(params)&&params.type?params.type:"sine",lp_freq=__.isObj(params)&&params.lp_freq?params.lp_freq:2e4,size=__.isObj(params)&&params.size?params.size:16;__().begin("gang_of_oscillators",params),__().gain();for(var i=0;i<size;i++)__().begin("v"+(i+1)).osc({type:type}).lowpass(lp_freq).gain(0).end("v"+(i+1)).connect("gain");return __.end("gang_of_oscillators"),cracked},cracked.monosynth=function(params){var methods={init:function(options){var opts=options||{},lfo_type=opts.lfo_type||"sawtooth",lfo_intensity=opts.lfo_intensity||0,lfo_speed=opts.lfo_speed||5,osc_type=opts.osc_type||"sine",osc_frequency=opts.osc_frequency||440,osc_detune=opts.osc_detune||0,lp_q=opts.lp_q||0,lp_frequency=opts.lp_frequency||440,adsr_envelope=opts.adsr_envelope||.5,gain_volume=opts.gain_volume||1;__().begin("monosynth",params).lfo({gain:lfo_intensity,frequency:lfo_speed,type:lfo_type}).osc({detune:osc_detune,frequency:osc_frequency,type:osc_type}).lowpass({q:lp_q,frequency:lp_frequency}).adsr({envelope:adsr_envelope}).gain({gain:gain_volume}).end("monosynth")},noteOn:function(params){var args=params||{},freq=__.isNum(params)?__.pitch2freq(params):__.pitch2freq(args.pitch),vel=__.isNum(args.velocity)?args.velocity/127:.5,env=args.envelope||[.01,.1,.5];cracked.each("monosynth",function(el,index,arr){cracked.exec("frequency",[freq],el.search("osc")),cracked.exec("volume",[vel],el.search("gain")),cracked.exec("adsr",["trigger",env],el.search("adsr"))})},noteOff:function(params){cracked.each("monosynth",function(el,index,arr){params=__.ifUndef(params,.1);var p=__.isNum(params)?params:__.ifUndef(params.envelope,.1);cracked.exec("adsr",["release",p],el.search("adsr"))})}};return methods[params]?methods[params].apply(this,Array.prototype.slice.call(arguments,1)):methods.init(params),cracked},cracked.polysynth=function(params){var methods={init:function(options){var opts=options||{};params=params||{},params.lfo_type=opts.lfo_type||"sawtooth",params.lfo_intensity=opts.lfo_intensity||0,params.lfo_speed=opts.lfo_speed||5,params.osc_type=opts.osc_type||"sine",params.osc_frequency=opts.osc_frequency||440,params.osc_detune=opts.osc_detune||0,params.lp_q=opts.lp_q||0,params.lp_frequency=opts.lp_frequency||440,params.adsr_envelope=opts.adsr_envelope||.5,params.gain_volume=opts.gain_volume||1,params.active_voices={},__().begin("polysynth",params).gain({gain:params.gain_volume}).end("polysynth")},noteOn:function(params){var args=params||{},note_number=__.isNum(params)?params:args.pitch,freq=__.pitch2freq(note_number),vel=__.isNum(args.velocity)?args.velocity/127:.5,env=args.envelope||[.01,.1,.5],instance_id=note_number+"_"+Date.now();cracked.each("polysynth",function(el,index,arr){var voices=el.getParams().settings.active_voices,settings=el.getParams().settings;voices[note_number]||(__.loop("toggle_grid"),__().lfo({type:settings.lfo_type,gain:settings.lfo_intensity,frequency:settings.lfo_speed,id:instance_id+"_lfo",class:instance_id+"_class",modulates:"frequency"}).osc({id:instance_id+"_osc",class:instance_id+"_class",frequency:freq,type:settings.osc_type,detune:settings.osc_detune}).adsr({envelope:env,id:instance_id+"_adsr",class:instance_id+"_class"}).lowpass({id:instance_id+"_lp",class:instance_id+"_class",frequency:settings.lp_frequency,q:settings.lp_q}).gain({id:instance_id+"_gain",class:instance_id+"_class",gain:vel}).connect(el),__.loop("toggle_grid"),cracked.exec("start",[],__.find("."+instance_id+"_class")),cracked.exec("adsr",["trigger",env],__.find("#"+instance_id+"_adsr")),voices[note_number]=instance_id)})},noteOff:function(params){cracked.each("polysynth",function(el,index,arr){var note_number=__.isNum(params)?params:params.pitch,release=__.ifUndef(params.envelope,.1),voices=el.getParams().settings.active_voices,instance_id=!!note_number&&voices[note_number];instance_id&&(cracked.exec("adsr",["release",release],__.find("#"+instance_id+"_adsr")),cracked.exec("remove",[1e3*release+250],__.find("."+instance_id+"_class")),delete voices[note_number])})},update:function(params){cracked.each("polysynth",function(el,index,arr){var settings=el.getParams().settings,voices=el.getParams().settings.active_voices;Object.keys(params).map(function(setting,index,arr){settings[setting]=params[setting]}),Object.keys(voices).map(function(pitch,index,arr){var instance_id=voices[pitch];Object.keys(params).map(function(param,index,arr){switch(param){case"lfo_speed":cracked.exec("frequency",[params[param]],__.find("#"+instance_id+"_lfo"));break;case"lfo_intensity":cracked.exec("volume",[params[param]],__.find("#"+instance_id+"_lfo"));break;case"lp_frequency":cracked.exec("frequency",[params[param]],__.find("#"+instance_id+"_lp"));break;case"lp_q":cracked.exec("q",[params[param]],__.find("#"+instance_id+"_lp"))}})})})}};return methods[params]?methods[params].apply(this,Array.prototype.slice.call(arguments,1)):methods.init(params),cracked},cracked.play=function(){return cracked("*").start(),cracked},cracked.scale=function(position,inMin,inMax,outMin,outMax,type){if("log"===type||"logarithmic"===type){var minVal=Math.log(outMin||1),maxVal=Math.log(outMax||1),scale=(maxVal-minVal)/(inMax-inMin);return Math.exp(minVal+scale*(position-inMin))}if("linear"===type||void 0===type){return parseFloat((position-inMin)*(outMax-outMin)/(inMax-inMin)+outMin).toFixed(2)}return console.error("scale: type "+type+" not supported."),position},cracked.sec2ms=function(second){return __.isNum(second)?1e3*second:(console.error("sec2ms: param not number"),second)},cracked.ms2sec=function(ms){return __.isNum(ms)?ms/1e3:(console.error("ms2sec: param not number"),ms)},cracked.ms2min=function(ms){return __.isNum(ms)?ms/1e3/60:(console.error("ms2min: param not number"),ms)},cracked.min2ms=function(minute){return __.isNum(minute)?1e3*minute*60:(console.error("min2ms: param not number"),minute)},cracked.isSupported=function(){return"AudioContext"in window||"webkitAudioContext"in window},cracked.pitch2freq=function(pitch){return 440*Math.pow(2,(Math.floor(pitch)-69)/12)},cracked.freq2pitch=function(freq){return Math.floor(69+12*Math.log2(freq/440))},cracked.pitch2note=function(notenum){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][notenum%12]+""+parseInt(notenum/12-1)}}();